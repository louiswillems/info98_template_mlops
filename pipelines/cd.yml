name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prd # Cible directe de l'environnement de production
    permissions:
      contents: write # Nécessaire pour git tag

    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TARGET_TOKEN: ${{ secrets.DATABRICKS_TARGET_TOKEN }}

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Deploy to Databricks (Production)
        run: |
          # J'ai remplacé la variable matrix par "prd" en dur
          databricks bundle deploy -t prd \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}"

      - name: Create Git Tag
        # Plus besoin de condition "if", car ce job est toujours pour la prod
        run: |
          VERSION=$(cat version.txt)
          git tag $VERSION || true 
          git push origin $VERSION || true